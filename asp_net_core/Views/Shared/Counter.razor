<h1>Counter</h1>

<p>Current count: @currentCount</p>
@using System.Text.Json;
@using System.Text.Json.Nodes
<button class="btn btn-primary" @onclick="CallBack">Click me</button>


<div class="leftDiv">
    <p>Desks:</p>
    <ul class="deskGrid">
    @foreach(string i in @receivedData)
    {
        <li>Desk:
            <a @onclick="() => GetTable(i)">@i</a>
            <p>@if(@data.ContainsKey(i)){@data[i]}</p>
        </li>
    }
    </ul>
</div>

<!--
<div class="rightDiv">
</div>
-->

@code {
    private int currentCount = 0;
    private string[] receivedData = [];
    private Dictionary<string, MarkupString> data = new();
    private HttpClient client = new();
    private CancellationTokenSource? _cts;

    private Task? _refreshTask;

    private System.Threading.Timer timer;

    private void StartAutoRefresh()
    {
        if (_cts != null) return; // already running

        _cts = new CancellationTokenSource();
        _refreshTask = Task.Run(() => RefreshLoopAsync(_cts.Token));
    }

    private void StopAutoRefresh()
    {
        _cts?.Cancel();
    }

    private async Task RefreshLoopAsync(CancellationToken token)
    {
        try
        {
            while (!token.IsCancellationRequested)
            {
                try
                {
                    await GetData();
                    // Ensure UI update from a background thread
                }
                catch (OperationCanceledException) { break; }
                catch
                {
                    // optionally log errors; swallow so the loop continues
                }

                await Task.Delay(100, token);
            }
        }
        finally
        {
            // clean up when loop ends
            _cts?.Dispose();
            _cts = null;
            _refreshTask = null;
        }
    }
    private void CallBack(object? state)
    {
        currentCount++;
        _ = InvokeAsync(GetData);
    }

    private async Task FetchTableData()
    {
        timer = new System.Threading.Timer(
            CallBack, 
            null, 
            TimeSpan.Zero, 
            TimeSpan.FromSeconds(1));
    }

    private async Task GetData()
    {

        client.BaseAddress = new Uri("http://simulator:6000");
        var response = await client.GetAsync("/api/v2/F7H1vM3kQ5rW8zT9xG2pJ6nY4dL0aZ3K/desks");
        // receivedData = await response.Content.ReadAsStringAsync() ?? "No content";
        var content = await response.Content.ReadAsStreamAsync();
        receivedData = await JsonSerializer.DeserializeAsync<string[]>(content) ?? [];
        foreach (string desk in receivedData)
        {
            await GetTable(desk);
        }
        await InvokeAsync(StateHasChanged);

        // client.Dispose();
    }

    private async Task GetTable(string desk)
    {
        var response = await client.GetAsync($"/api/v2/F7H1vM3kQ5rW8zT9xG2pJ6nY4dL0aZ3K/desks/{desk}");
        var content = await response.Content.ReadAsStreamAsync();
        var tableData = await JsonNode.ParseAsync(content);

        //data[desk] = new MarkupString($"""<div class=tableId style="{(tableData!.ToJsonString().Length == 0 ? "color:red;": "color:green;" )}">{tableData!["config"]?["name"]} {tableData!["config"]?["manufacturer"]} </div>"""
        //+ $"<div class=tableData>{tableData!["state"]}</div>");

        data[desk] = new MarkupString($"""<div class=tableId style="{(tableData!.ToJsonString().Length == 0 ? "color:red;": "color:green;" )}">{tableData!["config"]?["name"]} {tableData!["config"]?["manufacturer"]} </div>"""
        + $"<div class=tableData>{tableData!["state"]}</div>");


        // TO DO: implement table fetch

    }
}